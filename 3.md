# Invoice Agent - Latency Breakdown Flow

## ğŸ“Š Waterfall Diagram - Complete Execution Timeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INVOICE AGENT EXECUTION FLOW                          â”‚
â”‚                    (Total Time: 7.2s - 14.2s depending on scenario)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Query   â”‚  "Send me September invoice"
â”‚ Arrives      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: ROOT AGENT (Invoice Router)                                         â”‚
â”‚ â±ï¸  Time: 1.1 - 1.5 seconds                                                  â”‚
â”‚ â° Cumulative: 0s â†’ 1.1-1.5s                                                 â”‚
â”‚                                                                              â”‚
â”‚ What happens:                                                                â”‚
â”‚ â€¢ LLM analyzes user query                                                    â”‚
â”‚ â€¢ Decides which sub-agent to call                                            â”‚
â”‚ â€¢ Routes to "Invoice Retrieval Agent"                                        â”‚
â”‚                                                                              â”‚
â”‚ ğŸ’¡ Why it takes time:                                                        â”‚
â”‚ â€¢ Processing system prompt (~500 tokens)                                     â”‚
â”‚ â€¢ Analyzing conversation history                                             â”‚
â”‚ â€¢ Making routing decision                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: INVOICE RETRIEVAL AGENT                                             â”‚
â”‚ â±ï¸  Time: 1.0 - 1.2 seconds                                                  â”‚
â”‚ â° Cumulative: 1.1-1.5s â†’ 2.1-2.7s                                           â”‚
â”‚                                                                              â”‚
â”‚ What happens:                                                                â”‚
â”‚ â€¢ LLM understands "September invoice" request                                â”‚
â”‚ â€¢ Decides to call "fetch_invoice" tool                                       â”‚
â”‚ â€¢ Prepares tool parameters (month, year)                                     â”‚
â”‚                                                                              â”‚
â”‚ ğŸ’¡ Why it takes time:                                                        â”‚
â”‚ â€¢ Processing agent-specific prompt                                           â”‚
â”‚ â€¢ Understanding user intent                                                  â”‚
â”‚ â€¢ Generating tool call                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: FETCH INVOICE TOOL (API Call) - SCENARIO DEPENDENT                  â”‚
â”‚                                                                              â”‚
â”‚ ğŸ“Œ SCENARIO A: Single Invoice Found (Fast)                                  â”‚
â”‚ â±ï¸  Time: 0.2 seconds (200ms)                                                â”‚
â”‚ â° Cumulative: 2.1-2.7s â†’ 2.3-2.9s                                           â”‚
â”‚                                                                              â”‚
â”‚ ï¿½ SCENARIO B: Multiple Invoices Found (Slow)                               â”‚
â”‚ â±ï¸  Time: 3.0 - 5.0 seconds                                                  â”‚
â”‚ â° Cumulative: 2.1-2.7s â†’ 5.1-7.7s                                           â”‚
â”‚                                                                              â”‚
â”‚ What happens:                                                                â”‚
â”‚ â€¢ Calls IndiaMART API to fetch invoice data                                  â”‚
â”‚ â€¢ Retrieves invoice details (15+ fields per invoice)                         â”‚
â”‚ â€¢ Returns data to agent                                                      â”‚
â”‚                                                                              â”‚
â”‚ ğŸ’¡ Why it varies:                                                            â”‚
â”‚ â€¢ Single invoice: Quick database lookup (200ms)                              â”‚
â”‚ â€¢ Multiple invoices: Complex query + more data (3-5s)                        â”‚
â”‚ â€¢ Network latency: 50-100ms                                                  â”‚
â”‚ â€¢ Data serialization: Proportional to result size                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: AGENT ANALYZES TOOL RESPONSE âš ï¸ BIGGEST BOTTLENECK                  â”‚
â”‚                                                                              â”‚
â”‚ ğŸ“Œ SCENARIO A: Single Invoice (Moderate)                                    â”‚
â”‚ â±ï¸  Time: 5.0 seconds                                                        â”‚
â”‚ â° Cumulative: 2.3-2.9s â†’ 7.3-7.9s                                           â”‚
â”‚ ğŸ¯ TOTAL TIME: 7.3 - 7.9 seconds                                            â”‚
â”‚                                                                              â”‚
â”‚ ğŸ“Œ SCENARIO B: Multiple Invoices (Slow)                                     â”‚
â”‚ â±ï¸  Time: 6.5 - 6.9 seconds                                                  â”‚
â”‚ â° Cumulative: 5.1-7.7s â†’ 11.6-14.6s                                         â”‚
â”‚ ğŸ¯ TOTAL TIME: 11.6 - 14.6 seconds                                          â”‚
â”‚                                                                              â”‚
â”‚ What happens:                                                                â”‚
â”‚ â€¢ LLM reads verbose tool response (15 fields Ã— N invoices)                   â”‚
â”‚ â€¢ Extracts relevant information                                              â”‚
â”‚ â€¢ Formats response for user                                                  â”‚
â”‚ â€¢ Generates WhatsApp message with CTAs                                       â”‚
â”‚                                                                              â”‚
â”‚ ğŸ’¡ Why it takes so long:                                                     â”‚
â”‚ â€¢ Tool response is verbose (15 fields Ã— N invoices, ~800-2000 tokens)        â”‚
â”‚ â€¢ LLM processes all data even if not needed                                  â”‚
â”‚ â€¢ Generating structured output (JSON with message, CTAs, attachments)        â”‚
â”‚ â€¢ Multi-step reasoning (check invoices, format dates, create CTAs)           â”‚
â”‚ â€¢ More invoices = more processing time                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reply to     â”‚  "Here's your September 2024 invoice..."
â”‚ User         â”‚  [Invoice PDF attached]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    LATENCY BREAKDOWN - WATERFALL VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCENARIO A: Single Invoice (Fast Path)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Time â†’  0s    1s    2s    3s    4s    5s    6s    7s    8s    9s    10s
        â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚
        â”œâ”€â”€â”€â”€â”€â”¤ Router (1.1-1.5s)
              â”œâ”€â”€â”€â”€â”¤ Sub-Agent (1.0-1.2s)
                   â”œâ”¤ API Call (0.2s) âš¡ FAST
                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Analysis (5.0s) âš ï¸ SLOW
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        Total: 7.3 - 7.9 seconds

SCENARIO B: Multiple Invoices (Slow Path)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Time â†’  0s    1s    2s    3s    4s    5s    6s    7s    8s    9s    10s   11s   12s   13s   14s
        â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚
        â”œâ”€â”€â”€â”€â”€â”¤ Router (1.1-1.5s)
              â”œâ”€â”€â”€â”€â”¤ Sub-Agent (1.0-1.2s)
                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ API Call (3.0-5.0s) ğŸŒ SLOW
                                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Analysis (6.5-6.9s) âš ï¸ VERY SLOW
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        Total: 11.6 - 14.6 seconds

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component               â”‚ Scenario A   â”‚ Scenario B   â”‚ % of Total  â”‚ Optimization Target  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Root Agent (Routing)    â”‚ 1.1 - 1.5s   â”‚ 1.1 - 1.5s   â”‚   ~12%      â”‚ âœ… Prompt caching    â”‚
â”‚ Sub-Agent (Decision)    â”‚ 1.0 - 1.2s   â”‚ 1.0 - 1.2s   â”‚   ~10%      â”‚ âœ… Prompt caching    â”‚
â”‚ Tool Execution (API)    â”‚ 0.2s âš¡      â”‚ 3.0 - 5.0s   â”‚   3% / 30%  â”‚ âš ï¸  External (API)   â”‚
â”‚ Tool Response Analysis  â”‚ 5.0s         â”‚ 6.5 - 6.9s   â”‚   65% / 48% â”‚ ğŸ¯ PRIMARY TARGET    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                   â”‚ 7.3 - 7.9s   â”‚ 11.6 - 14.6s â”‚   100%      â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         WHY LATENCY VARIES (7.2s - 14.6s)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£  NUMBER OF INVOICES FOUND (BIGGEST FACTOR)
   â€¢ Single invoice: 0.2s API + 5.0s analysis = 7.3-7.9s total âš¡
   â€¢ Multiple invoices: 3-5s API + 6.5-6.9s analysis = 11.6-14.6s total ğŸŒ
   
   Why multiple invoices are slower:
   - API: More database queries, more data to serialize
   - Analysis: More tokens to process (15 fields Ã— N invoices)
   - Reasoning: Compare invoices, decide which to show

2ï¸âƒ£  QUERY COMPLEXITY
   â€¢ Simple: "September invoice" â†’ Fast routing (1.1s)
   â€¢ Complex: "Send me the invoice for the month before last" â†’ Slow routing (1.5s)

3ï¸âƒ£  REASONING DEPTH
   â€¢ Invoice exists â†’ Simple response (5.0s)
   â€¢ Invoice missing â†’ Complex response with alternatives (6.5s)
   â€¢ Multiple invoices â†’ Comparison + selection logic (6.9s)

4ï¸âƒ£  MODEL VARIABILITY
   â€¢ Low system load â†’ Faster inference
   â€¢ High system load â†’ Slower inference (Â±20% variance)

5ï¸âƒ£  CONVERSATION HISTORY SIZE
   â€¢ New conversation: Minimal context (~500 tokens)
   â€¢ Long conversation: More context (~1500 tokens) â†’ +0.3s


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         OPTIMIZATION OPPORTUNITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ HIGH IMPACT (Target: -50% latency)

1. OPTIMIZE TOOL RESPONSES (Target: 6.9s â†’ 3.0s)
   
   Current: Returns 15 fields per invoice (800 tokens for single, 2000+ for multiple)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Single Invoice Response (800 tokens):                            â”‚
   â”‚ {                                                                â”‚
   â”‚   "AR_INVOICE_REV_ID": "123456",                                 â”‚
   â”‚   "AR_INVOICE__DISPLAY_DATE": "15-Sep-2024",                     â”‚
   â”‚   "AR_INVOICE__TOTAL_AMOUNT": "5000",                            â”‚
   â”‚   "AR_INVOICE__GST_AMOUNT": "900",                               â”‚
   â”‚   "AR_INVOICE__NET_AMOUNT": "5900",                              â”‚
   â”‚   "AR_INVOICE__PAYMENT_STATUS": "Paid",                          â”‚
   â”‚   "AR_INVOICE__PAYMENT_DATE": "20-Sep-2024",                     â”‚
   â”‚   "AR_INVOICE__PAYMENT_MODE": "Online",                          â”‚
   â”‚   "AR_INVOICE__INVOICE_TYPE": "Regular",                         â”‚
   â”‚   "AR_INVOICE__BILLING_ADDRESS": "...",                          â”‚
   â”‚   "AR_INVOICE__SHIPPING_ADDRESS": "...",                         â”‚
   â”‚   "AR_INVOICE__ITEMS": [...],                                    â”‚
   â”‚   "AR_INVOICE__TERMS": "...",                                    â”‚
   â”‚   "AR_INVOICE__NOTES": "...",                                    â”‚
   â”‚   "AR_INVOICE__PDF_URL": "https://..."                           â”‚
   â”‚ }                                                                â”‚
   â”‚                                                                  â”‚
   â”‚ Multiple Invoices Response (2000+ tokens):                       â”‚
   â”‚ [                                                                â”‚
   â”‚   { ...15 fields... },  // Invoice 1                             â”‚
   â”‚   { ...15 fields... },  // Invoice 2                             â”‚
   â”‚   { ...15 fields... }   // Invoice 3                             â”‚
   â”‚ ]                                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   Optimized: Return only 6 essential fields (200 tokens single, 400 tokens multiple)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Single Invoice Response (200 tokens):                            â”‚
   â”‚ {                                                                â”‚
   â”‚   "invoice_id": "123456",                                        â”‚
   â”‚   "date": "15-Sep-2024",                                         â”‚
   â”‚   "amount": "â‚¹5,900",                                            â”‚
   â”‚   "status": "Paid",                                              â”‚
   â”‚   "pdf_url": "https://...",                                      â”‚
   â”‚   "display_name": "Invoice #123456 - Sep 2024"                   â”‚
   â”‚ }                                                                â”‚
   â”‚                                                                  â”‚
   â”‚ Multiple Invoices Response (400 tokens):                         â”‚
   â”‚ [                                                                â”‚
   â”‚   { ...6 fields... },  // Invoice 1                              â”‚
   â”‚   { ...6 fields... },  // Invoice 2                              â”‚
   â”‚   { ...6 fields... }   // Invoice 3                              â”‚
   â”‚ ]                                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   Impact: 
   - Single invoice: 75% fewer tokens â†’ 50% faster (5.0s â†’ 2.5s)
   - Multiple invoices: 80% fewer tokens â†’ 55% faster (6.9s â†’ 3.1s)

2. IMPLEMENT PROMPT CACHING (Target: 1.5s â†’ 0.5s)
   Current: System prompt processed every time
   Optimized: Cache static prompts for 1 hour
   Impact: 50% faster routing, 60% cost reduction

3. USE FASTER MODEL FOR SIMPLE TASKS (Target: 1.2s â†’ 0.4s)
   Current: Gemini 2.5 Flash for all tasks
   Optimized: Gemini 2.5 Flash Lite for routing
   Impact: 67% faster routing


âš¡ MEDIUM IMPACT (Target: -20% latency)

4. PARALLEL TOOL EXECUTION
   Current: Sequential tool calls
   Optimized: Parallel execution where possible
   Impact: 30% faster for multi-tool queries

5. STRUCTURED OUTPUT FORMAT
   Current: LLM generates free-form JSON
   Optimized: Use structured output schema
   Impact: 20% faster response generation


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         EXPECTED RESULTS AFTER OPTIMIZATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCENARIO A: Single Invoice (Fast Path)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component               â”‚ Current      â”‚ Optimized    â”‚ Improvement         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Root Agent (Routing)    â”‚ 1.1 - 1.5s   â”‚ 0.4 - 0.6s   â”‚ -67% (caching)      â”‚
â”‚ Sub-Agent (Decision)    â”‚ 1.0 - 1.2s   â”‚ 0.3 - 0.5s   â”‚ -70% (lite model)   â”‚
â”‚ Tool Execution (API)    â”‚ 0.2s         â”‚ 0.2s         â”‚ No change (external)â”‚
â”‚ Tool Response Analysis  â”‚ 5.0s         â”‚ 2.5s         â”‚ -50% (concise data) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                   â”‚ 7.3 - 7.9s   â”‚ 3.4 - 3.8s   â”‚ -53% average        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO B: Multiple Invoices (Slow Path)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component               â”‚ Current      â”‚ Optimized    â”‚ Improvement         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Root Agent (Routing)    â”‚ 1.1 - 1.5s   â”‚ 0.4 - 0.6s   â”‚ -67% (caching)      â”‚
â”‚ Sub-Agent (Decision)    â”‚ 1.0 - 1.2s   â”‚ 0.3 - 0.5s   â”‚ -70% (lite model)   â”‚
â”‚ Tool Execution (API)    â”‚ 3.0 - 5.0s   â”‚ 3.0 - 5.0s   â”‚ No change (external)â”‚
â”‚ Tool Response Analysis  â”‚ 6.5 - 6.9s   â”‚ 3.1 - 3.5s   â”‚ -52% (concise data) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                   â”‚ 11.6 - 14.6s â”‚ 6.8 - 9.6s   â”‚ -41% average        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OVERALL TARGETS:
â€¢ Fast queries (single invoice): 7.3-7.9s â†’ 3.4-3.8s (-53%)
â€¢ Slow queries (multiple invoices): 11.6-14.6s â†’ 6.8-9.6s (-41%)
â€¢ Average improvement: -47%
â€¢ Target: 90% of queries complete in under 5 seconds

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component               â”‚ Current      â”‚ Optimized    â”‚ Improvement         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Root Agent (Routing)    â”‚ 1.1 - 1.5s   â”‚ 0.4 - 0.6s   â”‚ -67% (caching)      â”‚
â”‚ Sub-Agent (Decision)    â”‚ 1.0 - 1.2s   â”‚ 0.3 - 0.5s   â”‚ -70% (lite model)   â”‚
â”‚ Tool Execution (API)    â”‚ 0.2 - 5.0s   â”‚ 0.2 - 5.0s   â”‚ No change (external)â”‚
â”‚ Tool Response Analysis  â”‚ 5.0 - 6.9s   â”‚ 2.0 - 3.0s   â”‚ -57% (concise data) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                   â”‚ 9.6 - 14.2s  â”‚ 3.9 - 9.1s   â”‚ -60% average        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Target: 95% of queries complete in under 5 seconds
```

## ğŸ¯ Key Takeaways

1. **Biggest Bottleneck**: Tool response analysis (53% of total time)
2. **Quick Win**: Optimize tool responses (75% token reduction)
3. **Easy Win**: Implement prompt caching (50% faster routing)
4. **Smart Win**: Use faster models for simple tasks (67% faster)

## ğŸ“ˆ Success Metrics

- **Current P95**: 14.2 seconds
- **Target P95**: 5.0 seconds
- **Improvement**: 65% faster
